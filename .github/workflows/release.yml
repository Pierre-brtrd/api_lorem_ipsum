name: ğŸš€ Auto Release

on:
    push:
        branches: [master]
        paths: ["CHANGELOG.md", "Cargo.toml"]

env:
    CARGO_TERM_COLOR: always

jobs:
    check-version:
        name: ğŸ” Check Version Changes
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}
            version-changed: ${{ steps.version.outputs.changed }}
            release-notes: ${{ steps.changelog.outputs.notes }}

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: ğŸ” Extract version from Cargo.toml
              id: version
              run: |
                  VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

                  # VÃ©rifier si la version a changÃ©
                  git show HEAD~1:Cargo.toml > previous_cargo.toml || echo 'version = "0.0.0"' > previous_cargo.toml
                  PREVIOUS_VERSION=$(grep '^version = ' previous_cargo.toml | sed 's/version = "\(.*\)"/\1/' || echo "0.0.0")

                  if [ "$VERSION" != "$PREVIOUS_VERSION" ]; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "Version changed from $PREVIOUS_VERSION to $VERSION"
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "Version unchanged: $VERSION"
                  fi

            - name: ğŸ“‹ Extract changelog for version
              id: changelog
              if: steps.version.outputs.changed == 'true'
              run: |
                  VERSION="${{ steps.version.outputs.version }}"

                  # Script pour extraire les notes de la version du CHANGELOG
                  cat << 'EOF' > extract_changelog.py
                  import re
                  import sys

                  def extract_version_notes(changelog_path, version):
                      with open(changelog_path, 'r', encoding='utf-8') as f:
                          content = f.read()
                      
                      # Pattern pour trouver la section de version
                      version_pattern = rf'## \[{re.escape(version)}\].*?(?=## \[|\Z)'
                      match = re.search(version_pattern, content, re.DOTALL)
                      
                      if match:
                          section = match.group(0)
                          # Nettoyer et formater les notes
                          lines = section.split('\n')[1:]  # Enlever la ligne de titre
                          notes = []
                          for line in lines:
                              line = line.strip()
                              if line and not line.startswith('## ['):
                                  notes.append(line)
                          
                          return '\n'.join(notes).strip()
                      
                      return f"Release notes for version {version}"

                  if __name__ == "__main__":
                      notes = extract_version_notes('CHANGELOG.md', sys.argv[1])
                      print(notes)
                  EOF

                  NOTES=$(python3 extract_changelog.py "$VERSION")

                  # Ã‰chapper les caractÃ¨res spÃ©ciaux pour GitHub Output
                  NOTES="${NOTES//'%'/'%25'}"
                  NOTES="${NOTES//$'\n'/'%0A'}"
                  NOTES="${NOTES//$'\r'/'%0D'}"

                  echo "notes=$NOTES" >> $GITHUB_OUTPUT

    release:
        name: ğŸš€ Create Release
        runs-on: ubuntu-latest
        needs: [check-version]
        if: needs.check-version.outputs.version-changed == 'true'

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ¦€ Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: ğŸ“¦ Cache dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: ğŸ—ï¸ Build release
              run: cargo build --release

            - name: ğŸ§ª Run tests
              run: cargo test --release

            - name: ğŸ“¦ Create release archive
              run: |
                  mkdir -p release-artifacts

                  # Copier l'exÃ©cutable
                  cp target/release/api_lorem_ipsum release-artifacts/

                  # Copier la documentation
                  cp README.md CHANGELOG.md LICENSE release-artifacts/

                  # CrÃ©er une archive
                  tar -czf api_lorem_ipsum-${{ needs.check-version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz -C release-artifacts .

                  # CrÃ©er un checksum
                  sha256sum api_lorem_ipsum-${{ needs.check-version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz > api_lorem_ipsum-${{ needs.check-version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz.sha256

            - name: ğŸ“ Generate detailed release notes
              id: release-notes
              run: |
                  VERSION="${{ needs.check-version.outputs.version }}"
                  BASIC_NOTES="${{ needs.check-version.outputs.release-notes }}"

                  cat << EOF > detailed_notes.md
                  # ğŸš€ API Lorem Ipsum v${VERSION}

                  ${BASIC_NOTES}

                  ---

                  ## ğŸ“¦ Installation

                  ### Depuis les sources
                  \`\`\`bash
                  git clone https://github.com/Pierre-brtrd/api_lorem_ipsum.git
                  cd api_lorem_ipsum
                  git checkout v${VERSION}
                  cargo build --release
                  \`\`\`

                  ### Archive binaire
                  TÃ©lÃ©chargez l'archive ci-dessous et extrayez-la :
                  \`\`\`bash
                  tar -xzf api_lorem_ipsum-${VERSION}-x86_64-unknown-linux-gnu.tar.gz
                  ./api_lorem_ipsum
                  \`\`\`

                  ## ğŸ” VÃ©rification

                  VÃ©rifiez l'intÃ©gritÃ© du fichier tÃ©lÃ©chargÃ© :
                  \`\`\`bash
                  sha256sum -c api_lorem_ipsum-${VERSION}-x86_64-unknown-linux-gnu.tar.gz.sha256
                  \`\`\`

                  ## ğŸ“š Documentation

                  - [README](https://github.com/Pierre-brtrd/api_lorem_ipsum/blob/v${VERSION}/README.md)
                  - [Guide de Contribution](https://github.com/Pierre-brtrd/api_lorem_ipsum/blob/v${VERSION}/CONTRIBUTING.md)
                  - [Architecture DDD](https://github.com/Pierre-brtrd/api_lorem_ipsum/blob/v${VERSION}/NEXT_STEPS.md)

                  ## ğŸ› ProblÃ¨mes Connus

                  Consultez les [issues ouvertes](https://github.com/Pierre-brtrd/api_lorem_ipsum/issues) pour les problÃ¨mes connus.

                  ---

                  **Version complÃ¨te du changelog** : [CHANGELOG.md](https://github.com/Pierre-brtrd/api_lorem_ipsum/blob/v${VERSION}/CHANGELOG.md)
                  EOF

                  echo "detailed-notes<<EOF" >> $GITHUB_OUTPUT
                  cat detailed_notes.md >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: ğŸ·ï¸ Create Git Tag
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "v${{ needs.check-version.outputs.version }}" -m "Release v${{ needs.check-version.outputs.version }}"
                  git push origin "v${{ needs.check-version.outputs.version }}"

            - name: ğŸš€ Create GitHub Release
              id: create-release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: v${{ needs.check-version.outputs.version }}
                  release_name: ğŸš€ API Lorem Ipsum v${{ needs.check-version.outputs.version }}
                  body: ${{ steps.release-notes.outputs.detailed-notes }}
                  draft: false
                  prerelease: ${{ contains(needs.check-version.outputs.version, 'alpha') || contains(needs.check-version.outputs.version, 'beta') || contains(needs.check-version.outputs.version, 'rc') }}

            - name: ğŸ“ Upload Release Assets
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create-release.outputs.upload_url }}
                  asset_path: ./api_lorem_ipsum-${{ needs.check-version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz
                  asset_name: api_lorem_ipsum-${{ needs.check-version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz
                  asset_content_type: application/gzip

            - name: ğŸ“ Upload Checksum
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create-release.outputs.upload_url }}
                  asset_path: ./api_lorem_ipsum-${{ needs.check-version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz.sha256
                  asset_name: api_lorem_ipsum-${{ needs.check-version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz.sha256
                  asset_content_type: text/plain

    notify:
        name: ğŸ“¢ Notify Release
        runs-on: ubuntu-latest
        needs: [check-version, release]
        if: needs.check-version.outputs.version-changed == 'true'

        steps:
            - name: ğŸ“¢ Create Release Announcement Issue
              uses: actions/github-script@v7
              with:
                  script: |
                      const version = '${{ needs.check-version.outputs.version }}';
                      const releaseNotes = `${{ needs.check-version.outputs.release-notes }}`;

                      const body = `# ğŸ‰ Nouvelle Release : v${version}

                      Une nouvelle version de l'API Lorem Ipsum vient d'Ãªtre publiÃ©e !

                      ## ğŸ“‹ Changements

                      ${releaseNotes}

                      ## ğŸ”— Liens

                      - **Release GitHub** : https://github.com/Pierre-brtrd/api_lorem_ipsum/releases/tag/v${version}
                      - **TÃ©lÃ©chargement** : [Archive binaire](https://github.com/Pierre-brtrd/api_lorem_ipsum/releases/download/v${version}/api_lorem_ipsum-${version}-x86_64-unknown-linux-gnu.tar.gz)
                      - **Documentation** : [README](https://github.com/Pierre-brtrd/api_lorem_ipsum/blob/v${version}/README.md)

                      ## ğŸ“¦ Installation

                      \`\`\`bash
                      # Depuis les sources
                      git clone https://github.com/Pierre-brtrd/api_lorem_ipsum.git
                      cd api_lorem_ipsum
                      git checkout v${version}
                      cargo build --release
                      \`\`\`

                      ## ğŸš€ Mise Ã  jour

                      Si vous utilisez dÃ©jÃ  l'API, pensez Ã  mettre Ã  jour vers cette nouvelle version !

                      ---

                      _Cette issue a Ã©tÃ© crÃ©Ã©e automatiquement par le workflow de release._`;

                      github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: `ğŸš€ Release v${version} disponible`,
                        body: body,
                        labels: ['release', 'announcement']
                      });
